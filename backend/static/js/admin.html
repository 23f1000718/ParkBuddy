<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/vue@3"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Admin Dashboard - ParkBuddy</title>
</head>
<body>
  <div id="adminApp" class="container-fluid p-4">
    <div class="row">
      <!-- Header -->
      <div class="col-12 mb-4">
        <h2><i class="bi bi-shield-check"></i> Admin Dashboard</h2>
        <p class="text-muted">Manage parking lots, users, and monitor system activity</p>
      </div>

      <!-- Statistics Cards -->
      <div class="col-md-2 mb-4">
        <div class="card bg-primary text-white">
          <div class="card-body text-center">
            <h4>{{ stats.total_lots }}</h4>
            <small>Total Lots</small>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-4">
        <div class="card bg-success text-white">
          <div class="card-body text-center">
            <h4>{{ stats.total_spots }}</h4>
            <small>Total Spots</small>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-4">
        <div class="card bg-info text-white">
          <div class="card-body text-center">
            <h4>{{ stats.available_spots }}</h4>
            <small>Available</small>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-4">
        <div class="card bg-warning text-white">
          <div class="card-body text-center">
            <h4>{{ stats.occupied_spots }}</h4>
            <small>Occupied</small>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-4">
        <div class="card bg-secondary text-white">
          <div class="card-body text-center">
            <h4>{{ stats.total_users }}</h4>
            <small>Users</small>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-4">
        <div class="card bg-danger text-white">
          <div class="card-body text-center">
            <h4>₹{{ stats.today_revenue }}</h4>
            <small>Revenue</small>
          </div>
        </div>
      </div>

      <!-- Parking Lots Management -->
      <div class="col-md-8 mb-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="bi bi-geo-alt"></i> Parking Lots Management</h5>
            <a href="/static/js/add_lot.html" class="btn btn-primary btn-sm">
              <i class="bi bi-plus-circle"></i> Add New Lot
            </a>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Price/Hour</th>
                    <th>Spots</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="lot in lots" :key="lot.id">
                    <td>
                      <strong>{{ lot.prime_location_name }}</strong>
                      <br><small class="text-muted">{{ lot.pin_code }}</small>
                    </td>
                    <td>{{ lot.address }}</td>
                    <td>₹{{ lot.price_per_hour }}</td>
                    <td>
                      <span class="badge bg-success">{{ lot.number_of_spots }}</span>
                    </td>
                    <td>
                      <span class="badge bg-info">Active</span>
                    </td>
                    <td>
                      <a :href="`/static/js/view_lot.html?id=${lot.id}`" class="btn btn-info btn-sm me-1">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a :href="`/static/js/edit_lot.html?id=${lot.id}`" class="btn btn-warning btn-sm me-1">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <button @click="deleteLot(lot.id)" class="btn btn-danger btn-sm">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="col-md-4 mb-4">
        <div class="card">
          <div class="card-header">
            <h5><i class="bi bi-graph-up"></i> Quick Stats</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Recent Reservations (24h)</label>
              <h4 class="text-primary">{{ stats.recent_reservations }}</h4>
            </div>
            <div class="mb-3">
              <label class="form-label">Most Popular Lot</label>
              <h6 class="text-success">{{ stats.most_popular_lot }}</h6>
            </div>
            <div class="mb-3">
              <label class="form-label">Utilization Rate</label>
              <div class="progress">
                <div class="progress-bar" :style="`width: ${utilizationRate}%`">
                  {{ utilizationRate }}%
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="card mt-4">
          <div class="card-header">
            <h5><i class="bi bi-pie-chart"></i> Spot Distribution</h5>
          </div>
          <div class="card-body">
            <canvas id="spotChart" width="300" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Users Management -->
      <div class="col-12 mb-4">
        <div class="card">
          <div class="card-header">
            <h5><i class="bi bi-people"></i> Registered Users</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="user in users" :key="user.id">
                    <td>{{ user.id }}</td>
                    <td>{{ user.name }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                      <button @click="viewUserDetails(user.id)" class="btn btn-info btn-sm me-1">
                        <i class="bi bi-eye"></i> View Details
                      </button>
                      <button @click="blockUser(user.id)" :class="user.is_active ? 'btn btn-warning btn-sm' : 'btn btn-success btn-sm'">
                        <i :class="user.is_active ? 'bi bi-lock' : 'bi bi-unlock'"></i>
                        {{ user.is_active ? 'Block' : 'Unblock' }}
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alert Messages -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 10000;">
      <div v-if="alert.show" :class="`alert alert-${alert.type} alert-dismissible fade show`" role="alert">
        {{ alert.message }}
        <button type="button" class="btn-close" @click="alert.show = false"></button>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          lots: [],
          users: [],
          stats: {
            total_lots: 0,
            total_spots: 0,
            available_spots: 0,
            occupied_spots: 0,
            total_users: 0,
            recent_reservations: 0,
            today_revenue: 0,
            most_popular_lot: 'None'
          },
          alert: { show: false, type: 'info', message: '' }
        };
      },
      computed: {
        utilizationRate() {
          if (this.stats.total_spots === 0) return 0;
          return Math.round((this.stats.occupied_spots / this.stats.total_spots) * 100);
        }
      },
      mounted() {
        this.fetchLots();
        this.fetchUsers();
        this.fetchStats();
      },
      methods: {
        showAlert(type, message) {
          this.alert = { show: true, type, message };
          setTimeout(() => {
            this.alert.show = false;
          }, 5000);
        },
        getToken() {
          return localStorage.getItem('token');
        },
        fetchLots() {
          fetch('/api/lots', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => this.lots = data)
          .catch(error => this.showAlert('danger', 'Error loading parking lots'));
        },
        fetchUsers() {
          fetch('/api/admin/users', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => this.users = data)
          .catch(error => this.showAlert('danger', 'Error loading users'));
        },
        fetchStats() {
          fetch('/api/admin/dashboard-stats', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => {
            this.stats = data;
            this.createCharts();
          })
          .catch(error => this.showAlert('danger', 'Error loading statistics'));
        },
        deleteLot(id) {
          if (confirm('Are you sure you want to delete this parking lot?')) {
          fetch(`/api/lots/${id}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${this.getToken()}` }
            })
            .then(res => res.json())
            .then(data => {
              if (res.ok) {
                this.showAlert('success', 'Parking lot deleted successfully!');
                this.fetchLots();
                this.fetchStats();
              } else {
                this.showAlert('danger', data.msg || 'Failed to delete parking lot');
              }
            })
            .catch(error => this.showAlert('danger', 'Error deleting parking lot'));
          }
        },
        viewUserDetails(userId) {
          fetch(`/api/admin/user-details/${userId}`, {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => {
            if (data.user) {
              const user = data.user;
              const stats = data.stats;
              const reservations = data.recent_reservations;
              
              let reservationsList = reservations.map(r => 
                `• ${r.lot_name} (${r.start_time} - ${r.end_time || 'Active'}) - ₹${r.cost || 'Pending'}`
              ).join('\n');
              
              const message = `User Details:\n\nName: ${user.name}\nEmail: ${user.email}\nStatus: ${user.is_active ? 'Active' : 'Blocked'}\n\nStatistics:\n• Total Reservations: ${stats.total_reservations}\n• Completed: ${stats.completed_reservations}\n• Total Spent: ₹${stats.total_spent}\n\nRecent Reservations:\n${reservationsList || 'No reservations found'}`;
              
              alert(message);
            } else {
              this.showAlert('danger', 'Failed to load user details');
            }
          })
          .catch(error => this.showAlert('danger', 'Error loading user details'));
        },
        blockUser(userId) {
          const user = this.users.find(u => u.id === userId);
          const action = user.is_active ? 'block' : 'unblock';
          
          if (confirm(`Are you sure you want to ${action} this user?`)) {
            fetch(`/api/admin/block-user/${userId}`, {
              method: 'POST',
              headers: { Authorization: `Bearer ${this.getToken()}` }
            })
            .then(res => {
              if (res.ok) {
                return res.json().then(data => {
                  this.showAlert('success', data.msg);
                  this.fetchUsers(); // Refresh user list
                });
              } else {
                return res.json().then(data => {
                  this.showAlert('danger', data.msg || `Failed to ${action} user`);
                });
              }
            })
            .catch(error => this.showAlert('danger', `Error ${action}ing user`));
          }
        },
        createCharts() {
          // Spot Distribution Chart
          const spotCtx = document.getElementById('spotChart');
          if (spotCtx) {
            new Chart(spotCtx, {
              type: 'doughnut',
              data: {
                labels: ['Available', 'Occupied'],
                datasets: [{
                  data: [this.stats.available_spots, this.stats.occupied_spots],
                  backgroundColor: [
                    'rgb(54, 162, 235)',
                    'rgb(255, 99, 132)'
                  ]
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'bottom'
                  }
                }
              }
            });
          }
        }
      }
    }).mount('#adminApp');
  </script>
</body>
</html>
