<!DOCTYPE html>
<html>
<head>
  <title>User Dashboard - ParkBuddy</title>
  <script src="https://unpkg.com/vue@3"></script>
<<<<<<< HEAD
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .lot-card { margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    .reservation-card { margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
  </style>
</head>
<body>
  <div id="userApp">
    <div class="container">
      <h2 class="mb-4">User Dashboard - ParkBuddy</h2>
      
      <div class="row">
        <div class="col-md-8">
          <h4>Available Parking Lots</h4>
          <div v-if="lots.length === 0" class="alert alert-info">
            No parking lots available.
          </div>
          
          <div v-for="lot in lots" :key="lot.id" class="lot-card">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h5 class="mb-1">{{ lot.prime_location_name }}</h5>
                <p class="mb-1"><strong>Price:</strong> ₹{{ lot.price_per_hour }}/hour</p>
                <p class="mb-1"><strong>Address:</strong> {{ lot.address }}</p>
                <p class="mb-0"><strong>Total Spots:</strong> {{ lot.number_of_spots }}</p>
              </div>
              <div class="col-md-4 text-end">
                <button @click="reserve(lot.id)" class="btn btn-primary">Reserve Spot</button>
=======
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="userApp" class="container-fluid p-4">
    <div class="row">
      <!-- Header -->
      <div class="col-12 mb-4">
        <h2><i class="bi bi-person-circle"></i> User Dashboard</h2>
        <p class="text-muted">Manage your parking reservations and view history</p>
      </div>

      <!-- Statistics Cards -->
      <div class="col-md-3 mb-4">
        <div class="card bg-primary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>{{ stats.total_reservations }}</h4>
                <p class="mb-0">Total Reservations</p>
              </div>
              <i class="bi bi-calendar-check" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="card bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>{{ stats.completed_reservations }}</h4>
                <p class="mb-0">Completed</p>
              </div>
              <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="card bg-info text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>₹{{ stats.total_cost }}</h4>
                <p class="mb-0">Total Spent</p>
              </div>
              <i class="bi bi-currency-rupee" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="card bg-warning text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>{{ activeReservations.length }}</h4>
                <p class="mb-0">Active</p>
              </div>
              <i class="bi bi-car-front" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Available Parking Lots -->
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h5><i class="bi bi-geo-alt"></i> Available Parking Lots</h5>
          </div>
          <div class="card-body">
            <div v-for="lot in lots" :key="lot.id" class="border rounded p-3 mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">{{ lot.prime_location_name }}</h6>
                  <small class="text-muted">
                    <i class="bi bi-geo-alt"></i> {{ lot.address }} ({{ lot.pin_code }})
                  </small><br>
                  <small class="text-success">
                    <i class="bi bi-currency-rupee"></i> {{ lot.price_per_hour }}/hour
                  </small>
                </div>
                <button @click="reserve(lot.id)" class="btn btn-primary btn-sm">
                  <i class="bi bi-bookmark-plus"></i> Reserve
                </button>
>>>>>>> fa507b6 (Amped up UI and milestone 6 implemented)
              </div>
            </div>
          </div>
        </div>
<<<<<<< HEAD
        
        <div class="col-md-4">
          <h4>My Reservations</h4>
          <button @click="loadReservations" class="btn btn-sm btn-outline-primary mb-3">Refresh</button>
          
          <div v-if="reservations.length === 0" class="alert alert-info">
            No reservations found.
          </div>
          
          <div v-for="reservation in reservations" :key="reservation.spot_id" class="reservation-card">
            <strong>{{ reservation.lot }}</strong><br>
            <small>Start: {{ reservation.start }}</small><br>
            <small v-if="reservation.end">End: {{ reservation.end }}</small>
            <small v-else class="text-success">Active</small><br>
            <small v-if="reservation.cost">Cost: ₹{{ reservation.cost }}</small>
          </div>
        </div>
      </div>
=======
      </div>

      <!-- Active Reservations -->
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h5><i class="bi bi-clock"></i> Active Reservations</h5>
          </div>
          <div class="card-body">
            <div v-if="activeReservations.length === 0" class="text-center text-muted">
              <i class="bi bi-inbox" style="font-size: 3rem;"></i>
              <p>No active reservations</p>
            </div>
            <div v-for="res in activeReservations" :key="res.id" class="border rounded p-3 mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">{{ res.lot }}</h6>
                  <small class="text-muted">
                    <i class="bi bi-clock"></i> Started: {{ res.start }}
                  </small><br>
                  <small class="text-info">
                    <i class="bi bi-stopwatch"></i> Duration: {{ res.parking_duration }} hours
                  </small>
                </div>
                <button @click="release(res.id)" class="btn btn-danger btn-sm">
                  <i class="bi bi-stop-circle"></i> Release
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Parking History -->
      <div class="col-12 mb-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="bi bi-clock-history"></i> Parking History</h5>
            <button @click="exportCSV" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-download"></i> Export CSV
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Lot</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Duration</th>
                    <th>Cost</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="res in reservations" :key="res.id">
                    <td>{{ res.lot }}</td>
                    <td>{{ res.start }}</td>
                    <td>{{ res.end || 'Active' }}</td>
                    <td>
                      <span v-if="res.end" class="badge bg-info">
                        {{ calculateDuration(res.start, res.end) }}
                      </span>
                      <span v-else class="badge bg-warning">Active</span>
                    </td>
                    <td>
                      <span v-if="res.cost" class="text-success">₹{{ res.cost }}</span>
                      <span v-else class="text-muted">-</span>
                    </td>
                    <td>
                      <span :class="res.status === 'Active' ? 'badge bg-warning' : 'badge bg-success'">
                        {{ res.status }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h5><i class="bi bi-graph-up"></i> Monthly Usage</h5>
          </div>
          <div class="card-body">
            <canvas id="usageChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h5><i class="bi bi-pie-chart"></i> Cost Breakdown</h5>
          </div>
          <div class="card-body">
            <canvas id="costChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Alert Messages -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
      <div v-if="alert.show" :class="`alert alert-${alert.type} alert-dismissible fade show`" role="alert">
        {{ alert.message }}
        <button type="button" class="btn-close" @click="alert.show = false"></button>
      </div>
>>>>>>> fa507b6 (Amped up UI and milestone 6 implemented)
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          lots: [],
<<<<<<< HEAD
          reservations: []
        };
      },
      mounted() {
        this.loadLots();
=======
          reservations: [],
          activeReservations: [],
          stats: {
            total_reservations: 0,
            completed_reservations: 0,
            total_cost: 0,
            most_used_lot: 'None'
          },
          alert: { show: false, type: 'info', message: '' }
        };
      },
      mounted() {
        this.loadData();
        this.loadStats();
        this.loadActiveReservations();
>>>>>>> fa507b6 (Amped up UI and milestone 6 implemented)
        this.loadReservations();
      },
      methods: {
        showAlert(type, message) {
          this.alert = { show: true, type, message };
          setTimeout(() => {
            this.alert.show = false;
          }, 5000);
        },
        getToken() {
          return localStorage.getItem('token');
        },
        loadData() {
          fetch('/api/lots', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => this.lots = data)
<<<<<<< HEAD
          .catch(err => console.error('Error loading lots:', err));
=======
          .catch(error => this.showAlert('danger', 'Error loading parking lots'));
        },
        loadStats() {
          fetch('/api/user/stats', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => {
            this.stats = data;
            this.createCharts();
          })
          .catch(error => this.showAlert('danger', 'Error loading statistics'));
        },
        loadActiveReservations() {
          fetch('/api/user/active-reservations', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => this.activeReservations = data)
          .catch(error => this.showAlert('danger', 'Error loading active reservations'));
        },
        loadReservations() {
          fetch('/api/user/reservations', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => this.reservations = data)
          .catch(error => this.showAlert('danger', 'Error loading reservations'));
>>>>>>> fa507b6 (Amped up UI and milestone 6 implemented)
        },
        reserve(lotId) {
          fetch(`/api/user/reserve/${lotId}`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => {
<<<<<<< HEAD
            alert(data.msg || 'Reserved!');
            this.loadReservations();
          })
          .catch(err => {
            console.error('Error reserving spot:', err);
            alert('Error reserving spot');
          });
        },
        loadReservations() {
          fetch('/api/user/reservations', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => this.reservations = data)
          .catch(err => console.error('Error loading reservations:', err));
=======
            if (res.ok) {
              this.showAlert('success', 'Spot reserved successfully!');
              this.loadData();
              this.loadActiveReservations();
              this.loadStats();
            } else {
              this.showAlert('danger', data.msg || 'Failed to reserve spot');
            }
          })
          .catch(error => this.showAlert('danger', 'Error reserving spot'));
        },
        release(resId) {
          if (confirm('Are you sure you want to release this parking spot?')) {
            fetch(`/api/user/release/${resId}`, {
              method: 'POST',
              headers: { Authorization: `Bearer ${this.getToken()}` }
            })
            .then(res => res.json())
            .then(data => {
              if (res.ok) {
                this.showAlert('success', `Spot released! Cost: ₹${data.cost}`);
                this.loadActiveReservations();
                this.loadReservations();
                this.loadStats();
              } else {
                this.showAlert('danger', data.msg || 'Failed to release spot');
              }
            })
            .catch(error => this.showAlert('danger', 'Error releasing spot'));
          }
        },
        exportCSV() {
          fetch('/api/user/export-csv', {
            method: 'POST',
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => {
            this.showAlert('success', 'CSV export started! Check your email.');
          })
          .catch(error => this.showAlert('danger', 'Error starting CSV export'));
        },
        calculateDuration(start, end) {
          const startDate = new Date(start);
          const endDate = new Date(end);
          const diffHours = (endDate - startDate) / (1000 * 60 * 60);
          return `${diffHours.toFixed(1)}h`;
        },
        createCharts() {
          // Usage Chart
          const usageCtx = document.getElementById('usageChart');
          if (usageCtx) {
            new Chart(usageCtx, {
              type: 'line',
              data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                  label: 'Reservations',
                  data: [12, 19, 3, 5, 2, 3],
                  borderColor: 'rgb(75, 192, 192)',
                  tension: 0.1
                }]
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              }
            });
          }

          // Cost Chart
          const costCtx = document.getElementById('costChart');
          if (costCtx) {
            new Chart(costCtx, {
              type: 'doughnut',
              data: {
                labels: ['Completed', 'Active'],
                datasets: [{
                  data: [this.stats.completed_reservations, this.activeReservations.length],
                  backgroundColor: [
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)'
                  ]
                }]
              },
              options: {
                responsive: true
              }
            });
          }
>>>>>>> fa507b6 (Amped up UI and milestone 6 implemented)
        }
      }
    }).mount('#userApp');
  </script>
</body>
</html>
