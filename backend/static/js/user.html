<!DOCTYPE html>
<html>
<head>
  <title>User Dashboard - ParkBuddy</title>
  <script src="https://unpkg.com/vue@3"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .lot-card { margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    .reservation-card { margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
  </style>
</head>
<body>
  <div id="userApp">
    <div class="container">
      <h2 class="mb-4">User Dashboard - ParkBuddy</h2>
      
      <div class="row">
        <div class="col-md-8">
          <h4>Available Parking Lots</h4>
          <div v-if="lots.length === 0" class="alert alert-info">
            No parking lots available.
          </div>
          
          <div v-for="lot in lots" :key="lot.id" class="lot-card">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h5 class="mb-1">{{ lot.prime_location_name }}</h5>
                <p class="mb-1"><strong>Price:</strong> ₹{{ lot.price_per_hour }}/hour</p>
                <p class="mb-1"><strong>Address:</strong> {{ lot.address }}</p>
                <p class="mb-0"><strong>Total Spots:</strong> {{ lot.number_of_spots }}</p>
              </div>
              <div class="col-md-4 text-end">
                <button @click="reserve(lot.id)" class="btn btn-primary">Reserve Spot</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <h4>My Reservations</h4>
          <button @click="loadReservations" class="btn btn-sm btn-outline-primary mb-3">Refresh</button>
          
          <div v-if="reservations.length === 0" class="alert alert-info">
            No reservations found.
          </div>
          
          <div v-for="reservation in reservations" :key="reservation.spot_id" class="reservation-card">
            <strong>{{ reservation.lot }}</strong><br>
            <small>Start: {{ reservation.start }}</small><br>
            <small v-if="reservation.end">End: {{ reservation.end }}</small>
            <small v-else class="text-success">Active</small><br>
            <small v-if="reservation.cost">Cost: ₹{{ reservation.cost }}</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          lots: [],
          reservations: []
        };
      },
      mounted() {
        this.loadLots();
        this.loadReservations();
      },
      methods: {
        getToken() {
          return localStorage.getItem('token');
        },
        loadLots() {
          fetch('/api/lots', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => this.lots = data)
          .catch(err => console.error('Error loading lots:', err));
        },
        reserve(lotId) {
          fetch(`/api/user/reserve/${lotId}`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => {
            alert(data.msg || 'Reserved!');
            this.loadReservations();
          })
          .catch(err => {
            console.error('Error reserving spot:', err);
            alert('Error reserving spot');
          });
        },
        loadReservations() {
          fetch('/api/user/reservations', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => this.reservations = data)
          .catch(err => console.error('Error loading reservations:', err));
        }
      }
    }).mount('#userApp');
  </script>
</body>
</html>
