<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/vue@3"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>User Dashboard - ParkBuddy</title>
</head>
<body>
  <div id="userApp" class="container-fluid p-4">
    <div class="row">
      <!-- Header -->
      <div class="col-12 mb-4">
        <h2><i class="bi bi-person-circle"></i> User Dashboard</h2>
        <p class="text-muted">Manage your parking reservations and view history</p>
      </div>

      <!-- Statistics Cards -->
      <div class="col-md-3 mb-4">
        <div class="card bg-primary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>{{ stats.total_reservations }}</h4>
                <p class="mb-0">Total Reservations</p>
              </div>
              <i class="bi bi-calendar-check" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="card bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>{{ stats.completed_reservations }}</h4>
                <p class="mb-0">Completed</p>
              </div>
              <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="card bg-info text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>₹{{ stats.total_cost }}</h4>
                <p class="mb-0">Total Spent</p>
              </div>
              <i class="bi bi-currency-rupee" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="card bg-warning text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>{{ activeReservations.length }}</h4>
                <p class="mb-0">Active</p>
              </div>
              <i class="bi bi-car-front" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Available Parking Lots -->
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h5><i class="bi bi-geo-alt"></i> Available Parking Lots</h5>
          </div>
          <div class="card-body">
            <div v-for="lot in lots" :key="lot.id" class="border rounded p-3 mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">{{ lot.prime_location_name }}</h6>
                  <small class="text-muted">
                    <i class="bi bi-geo-alt"></i> {{ lot.address }} ({{ lot.pin_code }})
                  </small><br>
                  <small class="text-success">
                    <i class="bi bi-currency-rupee"></i> {{ lot.price_per_hour }}/hour
                  </small>
                </div>
                <button @click="reserve(lot.id)" class="btn btn-primary btn-sm">
                  <i class="bi bi-bookmark-plus"></i> Reserve
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Reservations -->
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h5><i class="bi bi-clock"></i> Active Reservations</h5>
          </div>
          <div class="card-body">
            <div v-if="activeReservations.length === 0" class="text-center text-muted">
              <i class="bi bi-inbox" style="font-size: 3rem;"></i>
              <p>No active reservations</p>
            </div>
            <div v-for="res in activeReservations" :key="res.id" class="border rounded p-3 mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">{{ res.lot }}</h6>
                  <small class="text-muted">
                    <i class="bi bi-clock"></i> Started: {{ res.start }}
                  </small><br>
                  <small class="text-info">
                    <i class="bi bi-stopwatch"></i> Duration: {{ res.parking_duration }} hours
                  </small>
                </div>
                <button @click="release(res.id)" class="btn btn-danger btn-sm">
                  <i class="bi bi-stop-circle"></i> Release
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Parking History -->
      <div class="col-12 mb-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="bi bi-clock-history"></i> Parking History</h5>
            <button @click="exportCSV" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-download"></i> Export CSV
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Lot</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Cost</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="res in reservations" :key="res.id">
                    <td>{{ res.lot }}</td>
                    <td>{{ res.start }}</td>
                    <td>{{ res.end || '-' }}</td>
                    <td>{{ res.cost !== null ? '₹' + res.cost : '-' }}</td>
                    <td>
                      <span :class="res.status === 'Active' ? 'badge bg-warning text-dark' : 'badge bg-success'">
                        {{ res.status }}
                      </span>
                    </td>
                    <td>
                      <button v-if="res.status === 'Active'" @click="release(res.id)" class="btn btn-danger btn-sm">
                        <i class="bi bi-stop-circle"></i> Release
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5><i class="bi bi-pie-chart"></i> Reservation Status</h5>
            </div>
            <div class="card-body">
              <canvas id="reservationChart" width="300" height="200"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5><i class="bi bi-bar-chart"></i> Monthly Spending</h5>
            </div>
            <div class="card-body">
              <canvas id="spendingChart" width="300" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Alert Messages -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
      <div v-if="alert.show" :class="`alert alert-${alert.type} alert-dismissible fade show`" role="alert">
        {{ alert.message }}
        <button type="button" class="btn-close" @click="alert.show = false"></button>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          lots: [],
          reservations: [],
          activeReservations: [],
          stats: {
            total_reservations: 0,
            completed_reservations: 0,
            total_cost: 0
          },
          alert: { show: false, type: 'info', message: '' },
          _activeLoaded: false
        };
      },
      mounted() {
        this.loadData();
        this.loadStats();
        this.loadActiveReservations();
        this.loadReservations();
      },
      methods: {
        showAlert(type, message) {
          this.alert = { show: true, type, message };
          setTimeout(() => {
            this.alert.show = false;
          }, 5000);
        },
        getToken() {
          return localStorage.getItem('token');
        },
        loadData() {
          fetch('/api/user/lots', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => this.lots = data)
          .catch(error => this.showAlert('danger', 'Error loading parking lots'));
        },
        loadStats() {
          fetch('/api/user/stats', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => {
            this.stats = data;
          })
          .catch(error => console.error('Error loading stats:', error));
        },
        loadActiveReservations() {
          fetch('/api/user/active-reservations', {
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => {
            this.activeReservations = data;
            this._activeLoaded = true;
            this.updateChartsIfReady();
          })
          // No error popup for active reservations
        },
        loadReservations() {
  fetch('/api/user/reservations', {
    headers: { Authorization: `Bearer ${this.getToken()}` }
  })
  .then(res => {
    if (!res.ok) throw new Error('Network response was not ok');
    return res.json();
  })
  .then(data => {
    this.reservations = Array.isArray(data) ? data : [];
  })
  // No error popup for reservations
},
        reserve(lotId) {
          fetch(`/api/user/reserve/${lotId}`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => {
            if (res.ok) {
              return res.json().then(data => {
                this.showAlert('success', 'Spot reserved successfully!');
                this.loadData();
                this.loadActiveReservations();
                this.loadStats();
                
              });
            } else {
              return res.json().then(data => {
                this.showAlert('danger', data.msg || 'Failed to reserve spot');
              });
            }
          })
          .catch(error => this.showAlert('danger', 'Error reserving spot'));
        },
        release(resId) {
          if (confirm('Are you sure you want to release this parking spot?')) {
            fetch(`/api/user/release/${resId}`, {
              method: 'POST',
              headers: { Authorization: `Bearer ${this.getToken()}` }
            })
            .then(res => {
              if (res.ok) {
                return res.json().then(data => {
                  this.showAlert('success', `Spot released! Cost: ₹${data.cost}`);
                  this.loadActiveReservations();
                  this.loadReservations();
                  this.loadStats();
                  this.loadData();
                });
              } else {
                return res.json().then(data => {
                  this.showAlert('danger', data.msg || 'Failed to release spot');
                });
              }
            })
            .catch(error => this.showAlert('danger', 'Error releasing spot'));
          }
        },
        exportCSV() {
          fetch('/api/user/export-csv', {
            method: 'POST',
            headers: { Authorization: `Bearer ${this.getToken()}` }
          })
          .then(res => res.json())
          .then(data => {
            this.showAlert('success', 'CSV export started! Check your email.');
          })
          .catch(error => this.showAlert('danger', 'Error starting CSV export'));
        },
        calculateDuration(start, end) {
          const startDate = new Date(start);
          const endDate = new Date(end);
          const diffHours = (endDate - startDate) / (1000 * 60 * 60);
          return `${diffHours.toFixed(1)}h`;
        },

        updateCharts() {
          // Reservation Status Chart
          const ctx1 = document.getElementById('reservationChart');
          if (ctx1) {
            if (this._reservationChart) this._reservationChart.destroy();
            this._reservationChart = new Chart(ctx1, {
              type: 'doughnut',
              data: {
                labels: ['Completed', 'Active'],
                datasets: [{
                  data: [this.stats.completed_reservations || 0, this.stats.active_reservations || 0],
                  backgroundColor: ['#198754', '#0dcaf0']
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
              }
            });
          }

          // Monthly Spending Chart
          const ctx2 = document.getElementById('spendingChart');
          if (ctx2) {
            if (this._spendingChart) this._spendingChart.destroy();
            const labels = (this.stats.monthly_spending || []).map(m => m.month);
            const data = (this.stats.monthly_spending || []).map(m => m.amount);
            this._spendingChart = new Chart(ctx2, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: '₹ Spent',
                  data: data,
                  backgroundColor: '#0d6efd'
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                  y: { beginAtZero: true }
                }
              }
            });
          }
        }
      },
      watch: {
        stats: {
          handler() {
            this.updateCharts();
          },
          deep: true
        }
      },
      mounted() {
        this.loadStats();
        this.loadData();
        this.loadActiveReservations();
        this.loadReservations();
      },
      data() {
        return {
          lots: [],
          stats: {},
          activeReservations: [],
          reservations: [],
          alert: { show: false, type: '', message: '' },
          _reservationChart: null,
          _spendingChart: null
        };
      }
    }).mount('#userApp');
  </script>
</body>
</html>
